SELECT 
    ISNULL(C.NAME, 'NONE') AS [ASSEMBLY AREA],
    ISNULL(A.COSTCENTRE, '0') AS [CC],
    ISNULL(SUM(A.COST), '0') AS [TOTAL COST],
    ISNULL(SUM(A.TAXCOST), '0') AS [TAXABLE COST]
FROM (
    SELECT 
        COSTCENTRE,
        (FINAL_COST(PERCENTUSAGE, QTYREQD, MMSCOST, 0) - FINAL_COST(PERCENTUSAGE, QTYREQD, CORECOST, 0)) AS COST,
        FINAL_COST(PERCENTUSAGE, QTYREQD, MMSCOST, 0) AS TAXCOST
    FROM 
        SCPARTSUSED
    WHERE 
        LINKCODE = UPPER(@B1)
        AND REBUILTPART = 'N'
        AND LINKTYPE = 'RB'
    UNION ALL
    SELECT 
        NSCPARTSUSED.COSTCENTRE,
        (FINAL_COST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NONSTOCKCODEDPARTS.OEMPARTCOST, 0) - FINAL_COST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NSCPARTSUSED.CORECOST, 0)) AS COST,
        FINAL_COST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NONSTOCKCODEDPARTS.OEMPARTCOST, 0) AS TAXCOST
    FROM 
        NSCPARTSUSED
    LEFT JOIN 
        NONSTOCKCODEDPARTS ON NONSTOCKCODEDPARTS.ID = NSCPARTSUSED.ID
    WHERE 
        NSCPARTSUSED.LINKCODE = UPPER(@B1)
        AND NSCPARTSUSED.LINKTYPE = 'RB'
) A
INNER JOIN 
    COSTCENTRES C ON C.COSTCENTRE = A.COSTCENTRE
GROUP BY 
    A.COSTCENTRE, 
    C.NAME;
