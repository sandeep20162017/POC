// ── Open vehicle popup and load form partial
window.openEstimatePopup = function (vehicleId) {
    // Reset loading tracker
    window.currentlyLoadingTab = null;

    // Create or get Kendo Window
    var win = $("#estimatePopup").data("kendoWindow");
    if (!win) {
        win = $("#estimatePopup").kendoWindow({
            modal: true,
            width: 1150,
            height: 600,
            title: vehicleId === 0 ? "Add New Estimate" : "Estimate #" + vehicleId,
            visible: false,
            actions: ["Close"],
            activate: function () {
                // Ensure TabStrip is initialized after window becomes visible
                var ts = $("#estimateTabs").data("kendoTabStrip");
                if (!ts) {
                    $("#estimateTabs").kendoTabStrip({
                        animation: { open: { effects: "fadeIn" } },
                        select: onTabSelect
                    });
                }
            },
            deactivate: function () {
                if (pendingChanges && !confirm("Unsaved changes. Close anyway?")) {
                    return false;
                }
            }
        }).data("kendoWindow");
    }

    // Set title depending on mode
    win.title(vehicleId === 0 ? "Add New Estimate" : "Vehicle Estimate #" + vehicleId);

    // Show popup
    win.center().open();

    // Load the first tab content (Vehicle form)
    loadVehicleForm(vehicleId);

    // Reset state
    pendingChanges = false;
    currentVehicleId = vehicleId;
    window.tabContentLoaded = [false, false, false, false, false, false, false, false];

    // Disable non-Vehicle tabs for new records
    var tabStrip = $("#estimateTabs").data("kendoTabStrip");
    if (tabStrip) {
        if (vehicleId === 0) {
            for (var i = 1; i <= 7; i++) {
                tabStrip.enable(tabStrip.tabGroup.children().eq(i), false);
            }
        }
    } else {
        // If TabStrip isn't ready yet, disable tabs after init
        setTimeout(function () {
            var ts = $("#estimateTabs").data("kendoTabStrip");
            if (ts && vehicleId === 0) {
                for (var i = 1; i <= 7; i++) {
                    ts.enable(ts.tabGroup.children().eq(i), false);
                }
            }
        }, 100);
    }
};
