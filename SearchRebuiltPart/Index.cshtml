@model BCES.Models.Parts.RebuiltPart

@{
    ViewData["Title"] = "Rebuilt Parts";
}

<h2>Rebuilt Parts</h2>

@(Html.Kendo().Grid<BCES.Models.Parts.RebuiltPart>()
    .Name("RebuiltPartsGrid")
    .Columns(columns =>
    {
        columns.Bound(c => c.StockPartID).Title("ID").Width(50);
        columns.Bound(c => c.MMSStockCode).Title("Stock Code").Width(100);
        columns.Bound(c => c.StockPartDescription).Title("Description").Width(200);
        columns.Bound(c => c.Quantity).Title("Quantity").Width(75);
        columns.Command(command => command.Custom("EditDetails").Click("onEditDetails")).Title("Actions").Width(150);
    })
    .Pageable()
    .Sortable()
    .Filterable()
    .DataSource(dataSource => dataSource
        .Ajax()
        .Read(read => read.Url("/api/RebuiltParts"))
    )
)

<!-- Popup Template for Editing Details -->
<div id="detailsPopup" style="display:none;">
    <form id="detailsForm">
        <div class="k-edit-form-container">
            <div class="k-edit-label">ID</div>
            <div class="k-edit-field">
                @Html.TextBox("StockPartID", Model.StockPartID, new { @class = "k-textbox", @readonly = "readonly" })
            </div>

            <div class="k-edit-label">Stock Code</div>
            <div class="k-edit-field">
                @Html.TextBox("MMSStockCode", Model.MMSStockCode, new { @class = "k-textbox", @readonly = "readonly" })
            </div>

            <div class="k-edit-label">Description</div>
            <div class="k-edit-field">
                @Html.TextBox("StockPartDescription", Model.StockPartDescription, new { @class = "k-textbox", @readonly = "readonly" })
            </div>

            <div class="k-edit-label">Quantity</div>
            <div class="k-edit-field">
                @(Html.Kendo().NumericTextBox().Name("Quantity").Value((double)Model.Quantity))
            </div>

            <div class="k-edit-label">Core Cost</div>
            <div class="k-edit-field">
                @(Html.Kendo().NumericTextBox().Name("CoreCost").Value((double)Model.CoreCost))
            </div>
        </div>

        <!-- Custom Save and Cancel Buttons -->
        <div style="margin-top: 10px;">
            <button type="button" id="saveButton" class="k-button k-primary" onclick="saveDetails()">Save</button>
            <button type="button" id="cancelButton" class="k-button" onclick="closeDetailsPopup()">Cancel</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function onEditDetails(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            
            // Populate form fields with dataItem values
            $("#detailsForm [name='StockPartID']").val(dataItem.StockPartID);
            $("#detailsForm [name='MMSStockCode']").val(dataItem.MMSStockCode);
            $("#detailsForm [name='StockPartDescription']").val(dataItem.StockPartDescription);
            $("#detailsForm [name='Quantity']").data("kendoNumericTextBox").value(dataItem.Quantity);
            $("#detailsForm [name='CoreCost']").data("kendoNumericTextBox").value(dataItem.CoreCost);

            // Open the form in a Kendo Window
            $("#detailsPopup").kendoWindow({
                title: "Edit Part Details",
                modal: true,
                visible: false,
                width: "500px"
            }).data("kendoWindow").center().open();
        }

        function saveDetails() {
            var partData = {
                StockPartID: $("#detailsForm [name='StockPartID']").val(),
                MMSStockCode: $("#detailsForm [name='MMSStockCode']").val(),
                StockPartDescription: $("#detailsForm [name='StockPartDescription']").val(),
                Quantity: $("#detailsForm [name='Quantity']").data("kendoNumericTextBox").value(),
                CoreCost: $("#detailsForm [name='CoreCost']").data("kendoNumericTextBox").value()
            };

            $.ajax({
                url: '/api/RebuiltParts/Update',
                type: 'POST',
                data: JSON.stringify(partData),
                contentType: 'application/json',
                success: function(response) {
                    alert(response);
                    closeDetailsPopup();
                    $("#RebuiltPartsGrid").data("kendoGrid").dataSource.read(); // Refresh the grid
                },
                error: function(xhr) {
                    alert("Error saving data: " + xhr.responseText);
                }
            });
        }

        function closeDetailsPopup() {
            $("#detailsPopup").data("kendoWindow").close();
        }
    </script>
}
