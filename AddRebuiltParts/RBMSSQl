-- 1. Procedure Call
EXEC CESINQUIRY.RETRIEVEAUDIT6 @VIESTIMATENUMBER = :V00001, @VIESTIMATETYPE = :V00002, @VOCURSOR = :R000C000;

-- 2. SELECT from AUDITMODIFYHISTORY
SELECT * 
FROM AUDITMODIFYHISTORY 
WHERE ESTIMATENUMBER = :B2 
  AND ESTIMATETYPE = :B1 
  AND ESTIMATETYPE IN ('MB', 'RB', 'BUS', 'KIT', 'NSCP') 
ORDER BY DATECHANGED DESC;

-- 3. Complex Aggregation with Joins
SELECT ISNULL(C.NAME, 'NONE') AS [ASSEMBLY AREA], 
       ISNULL(A.COSTCENTRE, '0') AS [CC], 
       ISNULL(SUM(A.COST), '0') AS [TOTAL COST], 
       ISNULL(SUM(A.TAXCOST), '0') AS [TAXABLE COST]
FROM (
    SELECT COSTCENTRE, 
           (FINALCOST(PERCENTUSAGE, QTYREQD, MMSCOST, 0) - FINALCOST(PERCENTUSAGE, QTYREQD, CORECOST, 0)) AS COST, 
           FINALCOST(PERCENTUSAGE, QTYREQD, MMSCOST, 0) AS TAXCOST 
    FROM SCPARTSUSED 
    WHERE LINKCODE = UPPER('035434') 
      AND REBUILTPART = 'N' 
      AND LINKTYPE = 'RB' 
    UNION ALL 
    SELECT NSCPARTSUSED.COSTCENTRE, 
           (FINALCOST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NONSTOCKCODEDPARTS.OEMPARTCOST, 0) - FINALCOST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NSCPARTSUSED.CORECOST, 0)) AS COST, 
           FINALCOST(NSCPARTSUSED.PERCENTUSAGE, NSCPARTSUSED.QTYREQD, NONSTOCKCODEDPARTS.OEMPARTCOST, 0) AS TAXCOST 
    FROM NSCPARTSUSED 
    LEFT JOIN NONSTOCKCODEDPARTS ON NSCPARTSUSED.ID = NONSTOCKCODEDPARTS.ID 
    WHERE NSCPARTSUSED.LINKCODE = UPPER('035434') 
      AND NSCPARTSUSED.LINKTYPE = 'RB'
) A 
JOIN COSTCENTRES C ON C.COSTCENTRE = A.COSTCENTRE 
GROUP BY A.COSTCENTRE, C.NAME;

-- 4. INSERT into TEMPLABOURLIST
INSERT INTO TEMPLABOURLIST 
VALUES (:B9, :B8, :B7, :B3, ROUND((HHMMTOMINUTES(:B5) * :B1), 0), :B6, 
        (:B6 / 60) * ROUND(HHMMTOMINUTES(:B5) * :B1) * (:B3 / 100), 
        ROUND((:B3 / 100) * HHMMTOMINUTES(:B5) * :B1), 'RB', UPPER(:B4), 
        ROUND((:B3 / 100) * ROUND(HHMMTOMINUTES(:B2) * :B1));

-- 5. SELECT with JOIN on RBLISTOFBUSES
SELECT RBLISTOFBUSES.LISTID, LISTOFBUSES.DESCRIPTION 
FROM RBLISTOFBUSES 
JOIN LISTOFBUSES ON RBLISTOFBUSES.LISTID = LISTOFBUSES.LISTID 
WHERE RBLISTOFBUSES.REBUILTSTOCKNUM = '035434';

-- 6. Function and Alias Handling
SELECT CC AS [COST CENTRE], 
       DECIMALMINUTESTOHHMM(SUM(EXTENDEDTIME)) AS [LABOUR HRS], 
       SUM(TOTALCOST) AS [TOTAL COST] 
FROM TEMPLABOURLIST 
GROUP BY CC 
ORDER BY CC ASC;

-- 7. Handling Outer Joins and ISNULL
SELECT UPPER(SCPARTSUSED.MMSREBUILTCODE) AS [REBUILT NUMBER], 
       ISNULL(A.RBUNITCOST, 0) AS [UNIT COST], 
       UPPER(SCPARTSUSED.COSTCENTRE) AS [CC], 
       UPPER(SCPARTSUSED.QTYREQD) AS [QTY], 
       REPLACE(SCPARTSUSED.PERCENTUSAGE, ',', '.') AS [%], 
       SCPARTSUSED.CORECOST AS [CORE COST], 
       ISNULL(A.RBCOST, 0) AS [TOTAL COST], 
       UPPER(RBMASTERLIST.DETAILEDDESC) AS [DESCRIPTION], 
       UPPER(RBMASTERLIST.KEYWORD) AS [KEYWORD], 
       SCPARTSUSED.ROWID 
FROM SCPARTSUSED 
LEFT JOIN RBMASTERLIST ON RBMASTERLIST.REBUILTSTOCKNUM = SCPARTSUSED.MMSREBUILTCODE 
LEFT JOIN (
    SELECT ROUND(SUM(TOTALCOST), 2) AS RBCOST, 
           ROUND(SUM(TOTALUNITCOST), 2) AS RBUNITCOST, 
           RBREFERENCE 
    FROM TEMPMATERIALSLIST 
    GROUP BY RBREFERENCE
) A ON A.RBREFERENCE = SCPARTSUSED.MMSREBUILTCODE 
WHERE SCPARTSUSED.LINKCODE = '035434' 
  AND SCPARTSUSED.REBUILTPART = 'Y' 
  AND SCPARTSUSED.LINKTYPE = 'RB' 
ORDER BY SCPARTSUSED.MMSREBUILTCODE;

-- 8. Search Query with LIKE and TRIM
SELECT UPPER(MMSSTOCKCODE) AS [STOCK CODE], 
       UPPER(ISNULL(DETAILEDDESC, ' ')) AS [DESCRIPTION], 
       ISNULL(OEMPARTCOST, 0) AS [OEM PART COST], 
       ISNULL(MMSNEWCOST, 0) AS [PRICE], 
       UPPER(ISNULL(PARTTYPE, ' ')) AS [KEYWORD], 
       LASTMODIFIEDDATE AS [LAST MODIFIED DATE], 
       ROWID 
FROM STOCKCODEDPARTS 
WHERE ISNULL(MMSSTOCKCODE, ' ') LIKE '%' + LTRIM(RTRIM(:B4)) + '%' 
  AND UPPER(ISNULL(DETAILEDDESC, ' ')) LIKE '%' + LTRIM(RTRIM(UPPER(:B3))) + '%' 
  AND UPPER(ISNULL(PARTTYPE, ' ')) LIKE '%' + LTRIM(RTRIM(UPPER(:B2))) + '%' 
  AND (MMSNEWCOST >= :B1 OR MMSNEWCOST IS NULL) 
ORDER BY MMSSTOCKCODE;

-- 9. INSERT with Date Functions
INSERT INTO SCPARTSUSED (
    MMSSTOCKCODE, DATEENTERED, USERENTERED, MMSCOST, OEMCOST, 
    LASTMODIFIEDBY, LASTMODIFIEDDATE, COSTCENTRE, QTYREQD, 
    PERCENTUSAGE, LINKCODE, REBUILTPART, LINKTYPE, MMSREBUILTCODE, 
    CORECOST, REBPARTCOST
) 
VALUES (
    UPPER(:B13), GETDATE(), ISNULL(UPPER(:B10), ' '), ISNULL(:B12, 0), 
    ISNULL(:B11, 0), UPPER(:B10), GETDATE(), ISNULL(UPPER(:B9), ' '), 
    ISNULL(:B8, '0'), ISNULL(:B7, '0'), :B6, :B5, :B4, 
    ISNULL(:B3, ' '), ISNULL(:B2, 0), ISNULL(:B1, 0)
);

-- 10. SELECT DISTINCT with UPPER
SELECT DISTINCT UPPER(COSTCENTRE) AS COSTCENTRE 
FROM COSTCENTRES 
ORDER BY COSTCENTRE;

-- 11. Procedure Call for RETRIEVECOSTCENTRES
EXEC CESINQUIRY.RETRIEVECOSTCENTRES @VOCURSOR = :R000C000;

-- 12. SELECT DISTINCT with UPPER
SELECT DISTINCT UPPER(DETAILEDDESC) AS DETAILEDDESC 
FROM STOCKCODEDPARTS;

-- 13. SELECT DISTINCT with UPPER
SELECT DISTINCT UPPER(PARTTYPE) AS PARTTYPE 
FROM STOCKCODEDPARTS;

-- 14. SELECT DISTINCT with UPPER
SELECT DISTINCT UPPER(MMSSTOCKCODE) AS MMSSTOCKCODE, 
                UPPER(MMSSYNCDATE) AS MMSSYNCDATE 
FROM STOCKCODEDPARTS;
