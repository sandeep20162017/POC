window.initMakeVsBuyPopupForm = function () {
    console.warn('inside window.initMakeVsBuyPopupForm');

    var mode = $("#formMode").val();
    console.warn('mode : ', mode);
    if (!mode) return;

    // Bind dropdown AFTER widgets exist
    var ddl = $("#MbPrefix").data("kendoDropDownList");
    if (ddl) {
        ddl.bind("change", function () {
            $("#MbPrefixHidden").val(this.value());
        });
    }

    // Apply Add/Edit logic AFTER Kendo initializes
    setTimeout(function () {

        if (mode === "Add") {
            console.warn('Add mode - enabling edit controls');

            if (ddl) {
                ddl.enable(true);
                ddl.value(""); // force user to pick prefix
            }

            setPopupEditable(["MbPrefix"]);
            setPopupReadonly(["DateOpened", "MbNumber"]);
        }
        else {
            console.warn('Edit mode - making everything readonly except JobNumber');

            if (ddl) {
                var prefix = $("#MbPrefixHidden").val();

                if (!prefix) {
                    // Legacy row → show "Legacy Estimate"
                    ddl.value("");              // underlying value stays empty
                    ddl.text("Legacy Estimate"); // override visible text
                } else {
                    // New row → show actual prefix
                    ddl.value(prefix);
                }

                ddl.enable(false);
            }

            setPopupReadonly([
                "DateOpened", "Keyword", "Description",
                "BusType", "NumBusComp", "VendorPartNum",
                "BuyCode", "RebuildCode", "CoreCode", "AnnualUsage",
                "BenchNumber", "SampleProvided", "Recommendation",
                "BuyNewCost", "InternalCost", "SopNumber",
                "CoreCost", "JobNumber"
            ]);

            setPopupEditable(["JobNumber"]);
        }

    }, 100); // ensure widgets exist
};
