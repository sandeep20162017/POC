window.initMakeVsBuyPopupForm = function () {
    console.warn('inside window.initMakeVsBuyPopupForm');

    var mode = $("#formMode").val();
    console.warn('mode : ', mode);
    if (!mode) return;

    // 1️⃣ Get Kendo dropdown instance
    var ddl = $("#MbPrefix").data("kendoDropDownList");

    // 2️⃣ Sync dropdown → hidden field
    if (ddl) {
        ddl.bind("change", function () {
            $("#MbPrefixHidden").val(this.value());
        });
    }

    // 3️⃣ Apply Add/Edit logic AFTER Kendo fully initializes
    setTimeout(function () {

        if (mode === "Add") {
            console.warn('Add mode - enabling edit controls');

            if (ddl) {
                ddl.enable(true);

                // Default prefix = MBD
                ddl.value("MBD");
                $("#MbPrefixHidden").val("MBD");

                // Force UI refresh
                setTimeout(function () {
                    ddl.value("MBD");
                }, 10);
            }

            setPopupEditable(["MbPrefix"]);
            setPopupReadonly(["DateOpened", "MbNumber"]);
        }
        else {
            console.warn('Edit mode - making everything readonly except JobNumber');

            var prefix = $("#MbPrefixHidden").val();

            if (ddl) {
                if (!prefix) {
                    // Legacy row → show "Legacy Estimate"
                    ddl.value(""); // underlying value stays empty

                    // Force override AFTER Kendo renders
                    setTimeout(function () {
                        ddl.text("Legacy Estimate");
                    }, 10);
                } else {
                    // New row → show actual prefix
                    ddl.value(prefix);
                }

                ddl.enable(false);
            }

            setPopupReadonly([
                "DateOpened", "Keyword", "Description",
                "BusType", "NumBusComp", "VendorPartNum",
                "BuyCode", "RebuildCode", "CoreCode", "AnnualUsage",
                "BenchNumber", "SampleProvided", "Recommendation",
                "BuyNewCost", "InternalCost", "SopNumber",
                "CoreCost", "JobNumber"
            ]);

            setPopupEditable(["JobNumber"]);
        }

    }, 100); // ensure widgets exist
};
