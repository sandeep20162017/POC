 window.initVehiclePopupForm = function () {
     console.warn('inside window.initVehiclePopupForm');
     var mode = $("#formMode").val();
     console.warn('mode : ', mode);
     if (!mode) return;

     if (mode === "Add") {
         console.warn('Add');
         setPopupEditable([
             "VehSeriesCode", "NumOfVehicles", "ProjDesc",
             "Make", "VehModel", "Year",
             "Engine", "Transmission", "Differential", "Sopnumber"
         ]);
         setPopupReadonly(["VehicleListId", "ModifiedLastBy", "ModifiedLastDate"]);
     } else {
         console.warn('Edit');
         setPopupReadonly([
             "VehicleListId", "VehSeriesCode", "ProjDesc", "Make", "VehModel", "Year",
             "Engine", "Transmission", "Differential", "Sopnumber",
             "ModifiedLastBy", "ModifiedLastDate"
         ]);
         setPopupEditable(["NumOfVehicles"]);
     }
 };

 window.setPopupEditable = function (ids) {
     ids.forEach(function (id) {
         var widget = getKendoWidget(id);
         console.warn('setPopupEditable');
         console.warn(widget);
         if (widget) {
             widget.enable(true);
         } else {
             $("#" + id).prop("readonly", false).removeClass("k-state-disabled");
         }
     });
 };

 window.getKendoWidget = function (id) {
     var element = $("#" + id);
     return element.data("kendoComboBox") ||
         element.data("kendoDropDownList") ||
         element.data("kendoNumericTextBox") ||
         element.data("kendoDatePicker") ||
         element.data("kendoTextBox");
 };
 // ── Load the form into the first tab
 window.loadVehicleForm = function (vehicleId, callback) {
     console.warn('window.loadVehicleForm :', vehicleId);
     $.get('@Url.Action("GetVehicleById", "Vehicles")', { id: vehicleId }, function (html) {
         $("#vehicleTabContent").html(html);
         window.tabContentLoaded[0] = true;
         window.wireVehicleForm(); // rebind save/cancel/edit/etc

         var tabStrip = $("#estimateTabs").data("kendoTabStrip");

         // If it's an existing record, enable other tabs
         if (vehicleId !== 0 && tabStrip) {
             for (var i = 1; i <= 7; i++) {
                 tabStrip.enable(tabStrip.tabGroup.children().eq(i), true);
             }
         } else if (vehicleId === 0 && tabStrip) {
             // New record: disable all other tabs
             for (var i = 1; i <= 7; i++) {
                 tabStrip.enable(tabStrip.tabGroup.children().eq(i), false);
             }
         }

         if (typeof callback === "function") {
             callback();
         }
     });
 };

 // ── Wire up form submit and cancel actions
 window.wireVehicleForm = function () {
     $("#btnCancelVehicle").off("click").on("click", function () {
         if (pendingChanges) {
             showCloseConfirmation();
         } else {
             $("#estimatePopup").data("kendoWindow").close();
         }
     });

     $("#btnSave").off("click").on("click", function (e) {
         e.preventDefault();
         $("#vehicleForm").submit();
     });

     $("#vehicleForm").off("submit").on("submit", function (e) {
         e.preventDefault();

         // Validate form here if needed

         var vm = {
             VehicleListId: $("#VehicleListId").val(),
             VehSeriesCode: $("#VehSeriesCode").data("kendoComboBox").value(),
             NumOfVehicles: $("#NumOfVehicles").val(),
             ProjDesc: $("#ProjDesc").data("kendoComboBox").value(),
             Make: $("#Make").data("kendoComboBox").value(),
             VehModel: $("#VehModel").data("kendoComboBox").value(),
             Year: $("#Year").val(),
             Engine: $("#Engine").data("kendoComboBox").value(),
             Transmission: $("#Transmission").data("kendoComboBox").value(),
             Differential: $("#Differential").data("kendoComboBox").value(),
             Sopnumber: $("#Sopnumber").val()
         };

         var url = window.currentVehicleId === 0
             ? '@Url.Action("AddVehiclesView", "Vehicles")'
             : '@Url.Action("UpdateVehiclesView", "Vehicles")';

         $.ajax({
             url: url,
             type: 'POST',
             contentType: "application/json",
             data: JSON.stringify(vm),
             success: function (response) {
                 if (response && response.VehicleListId) {
                     pendingChanges = false;
                     $("#estimatePopup").data("kendoWindow").unbind("close");
                     window.currentVehicleId = response.VehicleListId;
                     $("#VehicleGrid").data("kendoGrid").dataSource.read();

                     // Update window title with new ID
                     var win = $("#estimatePopup").data("kendoWindow");
                     win.title("Vehicle Estimate #" + response.VehicleListId);

                     //kendo.alert(" Estimate #: " + response.VehicleListId + " Saved successfully!");
                    // $("#ScPartsPopupWindow").data("kendoWindow").close();
                    //Enable all the tabs
                     console.warn('calling alert');

                     var alertWindow = kendo.alert("Estimate #: " + response.VehicleListId + " saved successfully!");

                     if (alertWindow && alertWindow.bind) {
                         alertWindow.bind("close", function () {
                             console.warn('calling enableAllTabs');
                             //enableAllTabs();
                             var ts = $("#estimateTabs").data("kendoTabStrip");
                             for (var i = 1; i <= 7; i++) {
                                 console.log('enabling tabs');
                                 ts.enable(ts.tabGroup.children().eq(i), true);
                             }
                             // Refresh main Vehicle grid
                             console.warn('loadVehicleForm - A');
                             console.warn('window.currentVehicleId :', window.currentVehicleId);
                             loadVehicleForm(window.currentVehicleId, function () {
                                 setPopupReadonly([
                                     "VehicleListId", "VehSeriesCode", "ProjDesc", "Make", "VehModel", "Year",
                                     "Engine", "Transmission", "Differential", "Sopnumber",
                                     "ModifiedLastBy", "ModifiedLastDate"
                                 ]);

                                 setPopupEditable(["NumOfVehicles"]);
                             });

                             //////////////////////
                         });
                         
                     }
                 } else {
                     kendo.alert("Save succeeded but no Estimate ID was returned.");
                     $("#ScPartsPopupWindow").data("kendoWindow").close();
                 }
             },
             error: function () {
                 kendo.alert("Error saving data.");
             }
         });
     });

     // Track form changes
     $("#vehicleForm input, #vehicleForm select").off("change input").on("input change", function () {
         pendingChanges = true;
     });
 }

 // ── Open vehicle popup and load form partial
 window.openEstimatePopup = function (vehicleId) {
     console.warn('inside window.openEstimatePopup');
     var win = $("#estimatePopup").data("kendoWindow");
     window.currentVehicleId = vehicleId;
     pendingChanges = false; // Reset changes flag

     win.title(vehicleId === 0 ? "Add New Estimate" : "Vehicle Estimate #" + vehicleId);
     win.center().open();

     // Load vehicle tab first
     $("#vehicleTabContent").load('@Url.Action("GetVehicleById", "Vehicles")', { id: vehicleId }, function () {
         // Initialize Kendo UI widgets in the loaded content
         kendo.init($("#vehicleTabContent"));

         // Set values for Kendo widgets after initialization
         setTimeout(function () {
             // Set values for ComboBoxEditor fields
             setComboBoxValues();
             initVehiclePopupForm();
             wireVehicleForm();
         }, 100);

         if (vehicleId !== 0) {
             //enableAllTabs();
             
             var ts = $("#estimateTabs").data("kendoTabStrip");
             for (var i = 1; i <= 7; i++) {
                 console.log('enabling tabs');
                 ts.enable(ts.tabGroup.children().eq(i), true);
             }

         }
     });
 };
