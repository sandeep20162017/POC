SELECT 
    UPPER(NON_STOCK_CODED_PARTS.ORIG_SUPPLIER_NUM) AS [SUPPLIER NUMBER],
    UPPER(NON_STOCK_CODED_PARTS.ORIG_SUPPLIER_NAME) AS [SUPPLIER NAME],
    NON_STOCK_CODED_PARTS.OEM_PART_COST AS [UNIT COST],
    UPPER(NSC_PARTS_USED.QTY_REQD) AS [QTY],
    REPLACE(NSC_PARTS_USED.PERCENT_USAGE, ',', '.') AS [%],
    REPLACE(dbo.FINAL_COST(NSC_PARTS_USED.PERCENT_USAGE, NSC_PARTS_USED.QTY_REQD, NSC_PARTS_USED.CORECOST, 0), ',', '.') AS [CORE COST],
    REPLACE(dbo.FINAL_COST(NSC_PARTS_USED.PERCENT_USAGE, NSC_PARTS_USED.QTY_REQD, NON_STOCK_CODED_PARTS.OEM_PART_COST, 0), ',', '.') AS [TOTAL COST],
    UPPER(NSC_PARTS_USED.COST_CENTRE) AS [CC],
    ISNULL(UPPER(NON_STOCK_CODED_PARTS.DETAILED_DESC), '') AS [DESCRIPTION],
    ISNULL(UPPER(NON_STOCK_CODED_PARTS.KEYWORD), '') AS [KEYWORD],
    UPPER(NSC_PARTS_USED.ID) AS [ID],
    UPPER(NSC_PARTS_USED.LAST_MODIFIED_DATE) AS [LAST MODIFIED DATE],
    NSC_PARTS_USED.ROWID
FROM CES.NSC_PARTS_USED AS NSC_PARTS_USED
LEFT JOIN CES.NON_STOCK_CODED_PARTS AS NON_STOCK_CODED_PARTS
    ON NON_STOCK_CODED_PARTS.ID = NSC_PARTS_USED.ID
WHERE 
    NSC_PARTS_USED.LINK_CODE = @RebuiltPartNum
    AND NSC_PARTS_USED.LINK_TYPE = 'RB'
ORDER BY 
    NON_STOCK_CODED_PARTS.ORIG_SUPPLIER_NUM;
