My original two queries were working fine. Its not needed to make major changes. Print intermdiate reults in the original two queries and add logic for the new formula.
Add comments and exception handling.
Above code you provided has following errors
Msg 130, Level 15, State 1, Line 54
Cannot perform an aggregate function on an expression containing an aggregate or a subquery.
Msg 130, Level 15, State 1, Line 63
Cannot perform an aggregate function on an expression containing an aggregate or a subquery.
Msg 8117, Level 16, State 1, Line 90
Operand data type varchar is invalid for sum operator.
Msg 8117, Level 16, State 1, Line 102
Operand data type varchar is invalid for sum operator.
