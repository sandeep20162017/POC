-- Step 1: Delete Existing Data and Reseed Identity Columns

-- Delete data from all SBCES tables
DELETE FROM SBCES.EmployeeLabourEmplClass;
DELETE FROM SBCES.RbMasterlistCostCenters;
DELETE FROM SBCES.RbMasterlistTransmissions;
DELETE FROM SBCES.RbMasterlistEngines;
DELETE FROM SBCES.RbMasterlistVehicleList;
DELETE FROM SBCES.RbListOfBusesListOfBuses;
DELETE FROM SBCES.MbListOfBusesListOfBuses;
DELETE FROM SBCES.MbListOfBuses;
DELETE FROM SBCES.EmployeeLabour;
DELETE FROM SBCES.KitsUsed;
DELETE FROM SBCES.KitsMasterlist;
DELETE FROM SBCES.NscPartsUsed;
DELETE FROM SBCES.ScOemkitsTextData;
DELETE FROM SBCES.StockCodedParts;
DELETE FROM SBCES.ScPartsUsed;
DELETE FROM SBCES.RbListOfBuses;
DELETE FROM SBCES.RbMasterlist;
DELETE FROM SBCES.VehicleList;
DELETE FROM SBCES.EmplClass;
DELETE FROM SBCES.CostCenter;
DELETE FROM SBCES.Transmission;
DELETE FROM SBCES.Engine;

-- Reseed identity columns
DBCC CHECKIDENT ('SBCES.EmployeeLabourEmplClass', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbMasterlistCostCenters', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbMasterlistTransmissions', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbMasterlistEngines', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbMasterlistVehicleList', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbListOfBusesListOfBuses', RESEED, 0);
DBCC CHECKIDENT ('SBCES.MbListOfBusesListOfBuses', RESEED, 0);
DBCC CHECKIDENT ('SBCES.MbListOfBuses', RESEED, 0);
DBCC CHECKIDENT ('SBCES.EmployeeLabour', RESEED, 0);
DBCC CHECKIDENT ('SBCES.KitsUsed', RESEED, 0);
DBCC CHECKIDENT ('SBCES.KitsMasterlist', RESEED, 0);
DBCC CHECKIDENT ('SBCES.NscPartsUsed', RESEED, 0);
DBCC CHECKIDENT ('SBCES.ScOemkitsTextData', RESEED, 0);
DBCC CHECKIDENT ('SBCES.StockCodedParts', RESEED, 0);
DBCC CHECKIDENT ('SBCES.ScPartsUsed', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbListOfBuses', RESEED, 0);
DBCC CHECKIDENT ('SBCES.RbMasterlist', RESEED, 0);
DBCC CHECKIDENT ('SBCES.VehicleList', RESEED, 0);

-- Step 2: Insert Data into Static Tables

-- Insert into SBCES.Engine
INSERT INTO SBCES.Engine (Name)
SELECT DISTINCT NAME
FROM CES.ENGINES
WHERE NAME IS NOT NULL AND NAME <> '';

-- Insert into SBCES.Transmission
INSERT INTO SBCES.Transmission (Name)
SELECT DISTINCT NAME
FROM CES.TRANSMISSIONS
WHERE NAME IS NOT NULL AND NAME <> '';

-- Insert into SBCES.CostCenter
INSERT INTO SBCES.CostCenter (CostCentre, CostCentreName, DateEntered)
SELECT DISTINCT COST_CENTRE, DESCRIPTION, DATE_ENTERED
FROM CES.COST_CENTRES
WHERE COST_CENTRE IS NOT NULL AND COST_CENTRE <> '';

-- Insert into SBCES.EmplClass
INSERT INTO SBCES.EmplClass (LabourType, LabourDefn, WageGroup, HrsPerWeek, DateEntered, OverheadType)
SELECT DISTINCT LABOUR_TYPE, LABOUR_DEFN, WAGE_GROUP, HRS_PER_WEEK, DATE_ENTERED, OVERHEADTYPE
FROM CES.EMPL_CLASS
WHERE LABOUR_TYPE IS NOT NULL;

-- Step 3: Insert Data into Main Tables

-- Insert into SBCES.VehicleList
INSERT INTO SBCES.VehicleList (VehicleListId, VehSeriesCode, NumOfVehicles, ProjDesc, DateEntered, EnteredBy, ModifiedLastBy, ModifiedLastDate, Make, Model, Year, Engine, Transmission, Differential, SopNumber)
SELECT DISTINCT LIST_ID, VEH_SERIES_CODE, NUM_OF_VEHICLES, PROJ_DESC, DATE_ENTERED, ENTERED_BY, MODIFIED_LAST_BY, MODIFIED_LAST_DATE, MAKE, MODEL, YEAR, ENGINE, TRANSMISSION, DIFFERENTIAL, SOPNUMBER
FROM CES.VEHICLE_LIST
WHERE LIST_ID IS NOT NULL AND VEH_SERIES_CODE IS NOT NULL AND NUM_OF_VEHICLES IS NOT NULL AND PROJ_DESC IS NOT NULL AND DATE_ENTERED IS NOT NULL AND ENTERED_BY IS NOT NULL AND MODIFIED_LAST_BY IS NOT NULL AND MODIFIED_LAST_DATE IS NOT NULL;

-- Insert into SBCES.RbMasterlist
INSERT INTO SBCES.RbMasterlist (MmsStockCode, ItemRefNumber, DetailedDesc, Keyword, CorePartNum, RebuiltStockNum, CoreCharge, JobNumber, DateModified, LastModifiedBy, EstimatedCost, SopNumber, BuyNewCost, RemanCost, ExternalCost, DateConverted, Active)
SELECT DISTINCT MMS_STCK_CODE, ITEM_REF_NUMBER, DETAILED_DESC, KEYWORD, CORE_PART_NUM, REBUILT_STOCK_NUM, CORE_CHARGE, JOB_NUMBER, DATE_MODIFIED, LAST_MODIFIED_BY, ESTIMATED_COST, SOP_NUMBER, BUY_NEW_COST, REMAN_COST, EXTERNAL_COST, DATE_CONVERTED, ACTIVE
FROM CES.RB_MASTERLIST
WHERE MMS_STCK_CODE IS NOT NULL AND REBUILT_STOCK_NUM IS NOT NULL;

-- Insert into SBCES.RbListOfBuses
INSERT INTO SBCES.RbListOfBuses (RebuiltStockNum, VehicleListId)
SELECT DISTINCT R.REBUILT_STOCK_NUM, V.VehicleListId
FROM CES.RB_LIST_OF_BUSES R
JOIN SBCES.VehicleList V ON R.LIST_ID = V.VehicleListId
WHERE R.REBUILT_STOCK_NUM IS NOT NULL AND V.VehicleListId IS NOT NULL;

-- Insert into SBCES.ScPartsUsed
INSERT INTO SBCES.ScPartsUsed (MmsStockCode, DateEntered, RebPartCost, UserEntered, MmsCost, OemCost, LastModifiedBy, LastModifiedDate, MmsRebuiltCode, CostCentre, QtyReqd, PercentUsage, LinkCode, RebuiltPart, LinkType, CoreCost, OrigSuppNum, OrigSupplierName)
SELECT DISTINCT MMS_STOCK_CODE, DATE_ENTERED, REB_PART_COST, USER_ENTERED, MMS_COST, OEM_COST, LAST_MODIFIED_BY, LAST_MODIFIED_DATE, MMS_REBUILT_CODE, COST_CENTRE, QTY_REQD, PERCENT_USAGE, LINK_CODE, REBUILT_PART, LINK_TYPE, CORECOST, ORIG_SUPP_NUM, ORIG_SUPPLIER_NAME
FROM CES.SC_PARTS_USED
WHERE MMS_STOCK_CODE IS NOT NULL AND COST_CENTRE IS NOT NULL;

-- Insert into SBCES.StockCodedParts
INSERT INTO SBCES.StockCodedParts (PartNo, CorePartNumber, PartType, JobNumber, DetailedDesc, DateEntered, ItemRefNumber, OverheadType, CoreCharge, PartCost, LastModifiedDate, LastModifiedBy, AddedBy, MmsNewCost, MmsSyncDate, OrigSupplierNum, OrigSupplierName)
SELECT DISTINCT MMS_STOCK_CODE, CORE_PART_NUMBER, PART_TYPE, JOB_NUMBER, DETAILED_DESC, DATE_ENTERED, ITEM_REF_NUMBER, OVERHEADTYPE, CORE_CHARGE, PART_COST, LAST_MODIFIED_DATE, LAST_MODIFIED_BY, ADDED_BY, MMS_NEW_COST, MMS_SYNC_DATE, ORIG_SUPPLIER_NUM, ORIG_SUPPLIER_NAME
FROM CES.STOCK_CODED_PARTS
WHERE MMS_STOCK_CODE IS NOT NULL;

-- Insert into SBCES.ScOemkitsTextData
INSERT INTO SBCES.ScOemkitsTextData (PartNo, TextData)
SELECT DISTINCT MMS_STOCK_CODE, TEXT_DATA
FROM CES.SC_OEMKITS_TEXT_DATA
WHERE MMS_STOCK_CODE IS NOT NULL;

-- Insert into SBCES.NscPartsUsed
INSERT INTO SBCES.NscPartsUsed (OrigSuppNum, OrigSupplierName, CostCentre, QtyReqd, PercentUsage, DateEntered, EnteredBy, LastModifiedBy, LastModifiedDate, LinkCode, Cost, LinkType, CoreCost, Id)
SELECT DISTINCT ORIG_SUPP_NUM, ORIG_SUPPLIER_NAME, COST_CENTRE, QTY_REQD, PERCENT_USAGE, DATE_ENTERED, ENTERED_BY, LAST_MODIFIED_BY, LAST_MODIFIED_DATE, LINK_CODE, COST, LINK_TYPE, CORECOST, ID
FROM CES.NSC_PARTS_USED
WHERE COST_CENTRE IS NOT NULL;

-- Insert into SBCES.KitsMasterlist
INSERT INTO SBCES.KitsMasterlist (PartNo, EstimatedCost, Keyword, DetailedDesc, ModifiedLastBy, ModifiedLastDate, DateEntered)
SELECT DISTINCT PART_NUMBER, ESTIMATED_COST, KEYWORD, DETAILED_DESC, MODIFIED_LAST_BY, MODIFIED_LAST_DATE, DATE_ENTERED
FROM CES.KITS_MASTERLIST
WHERE PART_NUMBER IS NOT NULL;

-- Insert into SBCES.KitsUsed
INSERT INTO SBCES.KitsUsed (PartNo, DateEntered, UserEntered, LastModifiedBy, LastModifiedDate, CostCentre, LinkCode)
SELECT DISTINCT PART_NUMBER, DATE_ENTERED, USER_ENTERED, LAST_MODIFIED_BY, LAST_MODIFIED_DATE, COST_CENTRE, LINK_CODE
FROM CES.KITS_USED
WHERE PART_NUMBER IS NOT NULL AND COST_CENTRE IS NOT NULL;

-- Insert into SBCES.LabourTaskDescriptions
INSERT INTO SBCES.LabourTaskDescriptions (TaskDescription)
SELECT DISTINCT TASK_DESCRIPTION
FROM CES.LABOUR_TASK_DESCRIPTIONS
WHERE TASK_DESCRIPTION IS NOT NULL AND TASK_DESCRIPTION <> '';

-- Insert into SBCES.EmployeeLabour
INSERT INTO SBCES.EmployeeLabour (LabourDefn, DateEntered, LinkNumber, TypeId, CostCentre, Task, LabourType, Usage, HrsReqd, AdjHrs, DateRevised, TimeAddition, RebuiltPartNum, LastModifiedBy)
SELECT DISTINCT LABOUR_DEFN, DATE_ENTERED, LINK_NUMBER, TYPEID, COSTCENTRE, TASK, LABOUR_TYPE, USAGE, HRS_REQD, ADJ_HRS, DATE_REVISED, TIME_ADDITION, REBUILT_PART_NUM, LAST_MODIFIED_BY
FROM CES.EMPLOYEE_LABOUR
WHERE COSTCENTRE IS NOT NULL AND TASK IS NOT NULL AND LABOUR_TYPE IS NOT NULL;

-- Insert into SBCES.MbListOfBuses
INSERT INTO SBCES.MbListOfBuses (MbNumber, VehicleListId)
SELECT DISTINCT M.MB_NUMBER, V.VehicleListId
FROM CES.MB_LIST_OF_BUSES M
JOIN SBCES.VehicleList V ON M.LIST_ID = V.VehicleListId
WHERE M.MB_NUMBER IS NOT NULL AND V.VehicleListId IS NOT NULL;

-- Step 4: Insert Data into Linking Tables

-- Insert into SBCES.RbMasterlistVehicleList
INSERT INTO SBCES.RbMasterlistVehicleList (MmsStockCode, VehicleListId)
SELECT DISTINCT R.MMS_STCK_CODE, V.VehicleListId
FROM CES.RB_MASTERLIST R
JOIN SBCES.VehicleList V ON R.SOP_NUMBER = V.SopNumber
WHERE R.MMS_STCK_CODE IS NOT NULL AND V.VehicleListId IS NOT NULL;

-- Insert into SBCES.RbMasterlistEngines
INSERT INTO SBCES.RbMasterlistEngines (MmsStockCode, EngineName)
SELECT DISTINCT R.MMS_STCK_CODE, E.Name
FROM CES.RB_MASTERLIST R
JOIN SBCES.Engine E ON R.ENGINE = E.Name
WHERE R.MMS_STCK_CODE IS NOT NULL AND E.Name IS NOT NULL;

-- Insert into SBCES.RbMasterlistTransmissions
INSERT INTO SBCES.RbMasterlistTransmissions (MmsStockCode, TransmissionName)
SELECT DISTINCT R.MMS_STCK_CODE, T.Name
FROM CES.RB_MASTERLIST R
JOIN SBCES.Transmission T ON R.TRANSMISSION = T.Name
WHERE R.MMS_STCK_CODE IS NOT NULL AND T.Name IS NOT NULL;

-- Insert into SBCES.RbMasterlistCostCenters
INSERT INTO SBCES.RbMasterlistCostCenters (MmsStockCode, CostCentre)
SELECT DISTINCT R.MMS_STCK_CODE, C.CostCentre
FROM CES.RB_MASTERLIST R
JOIN SBCES.CostCenter C ON R.COST_CENTRE = C.CostCentre
WHERE R.MMS_STCK_CODE IS NOT NULL AND C.CostCentre IS NOT NULL;

-- Insert into SBCES.EmployeeLabourEmplClass
INSERT INTO SBCES.EmployeeLabourEmplClass (EmployeeLabourId, EmplClassId)
SELECT DISTINCT E.Id, EC.LabourType
FROM SBCES.EmployeeLabour E
JOIN SBCES.EmplClass EC ON E.LabourType = EC.LabourType
WHERE E.Id IS NOT NULL AND EC.LabourType IS NOT NULL;

-- Insert into SBCES.MbListOfBusesListOfBuses
INSERT INTO SBCES.MbListOfBusesListOfBuses (MbListOfBusesId, VehicleListId)
SELECT DISTINCT M.MbListOfBusesId, V.VehicleListId
FROM SBCES.MbListOfBuses M
JOIN SBCES.VehicleList V ON M.VehicleListId = V.VehicleListId
WHERE M.MbListOfBusesId IS NOT NULL AND V.VehicleListId IS NOT NULL;

-- Insert into SBCES.RbListOfBusesListOfBuses
INSERT INTO SBCES.RbListOfBusesListOfBuses (RbListOfBusesId, VehicleListId)
SELECT DISTINCT R.RbListOfBusesId, V.VehicleListId
FROM SBCES.RbListOfBuses R
JOIN SBCES.VehicleList V ON R.VehicleListId = V.VehicleListId
WHERE R.RbListOfBusesId IS NOT NULL AND V.VehicleListId IS NOT NULL;