@model IEnumerable<BCES.Models.Parts.StockCodedPartsViewModel>

@{
    var partsList = Model ?? Enumerable.Empty<BCES.Models.Parts.StockCodedPartsViewModel>();

    ViewData["Title"] = "Stock Coded Parts Details";
    var scGridName = $"ScPartsMaterialDetailsRebuiltPartsGrid";
    bool isArchived = ViewBag.GridType == "ArchivedVehicleGrid";
    bool isAdmin = ViewBag.RoleId == 1;
    ViewBag.scGridName = scGridName;
    string gridName = $"ScPartsMaterialDetailsRebuiltPartsGrid_{ViewBag.PartNum}";
}

<script>
    var scInEstimateGridName = '@gridName';
</script>

<input type="hidden" id="scGridNameField" value="@scGridName" />

<h6>Stock Coded Parts Used</h6>

@(Html.Kendo().Grid<BCES.Models.Parts.StockCodedPartsViewModel>()
    .Name(gridName)
    .HtmlAttributes(new { data_grid_type = ViewBag.GridType?.ToString() ?? "RbGrid" })
    .Events(events => events
        .DataBound("onGridDataBound")
        .Save("onGridCellSave")
        .CellClose("onGridCellClose")
    )
    .Columns(columns =>
    {
        columns.Bound(c => c.MMSStockCode)
            .Title("Stock Code")
            .HtmlAttributes(new { @class = "stock-code-cell", data_field = "MMSStockCode" })
            .IncludeInMenu(false)
            .HeaderHtmlAttributes(new { @class = "required-header" })
            .HtmlAttributes(new { @class = "required-cell", required = "required" })
            .EditorTemplateName("ScComboBox")
            .Width(180);

        columns.Bound(c => c.PartType)
            .Title("Part Type")
            .Width(150)
            .EditorTemplateName("ComboBoxEditor")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Bound(c => c.OrigSupplierNum)
            .Title("Supplier Num")
            .Width(150)
            .Filterable(ftb => ftb.Cell(cell => cell.Operator("contains").SuggestionOperator(FilterType.Contains)))
            .EditorTemplateName("ComboBoxEditor")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Bound(c => c.OrigSupplierName)
            .Title("Supplier Name")
            .Width(150)
            .Filterable(ftb => ftb.Cell(cell => cell.Operator("contains").SuggestionOperator(FilterType.Contains)))
            .EditorTemplateName("ComboBoxEditor")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Bound(c => c.DetailedDesc)
            .Title("Part Description")
            .Width(150)
            .EditorTemplateName("ComboBoxEditor")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Bound(c => c.UnitCost)
            .Title("Part Unit Cost")
            .Width(90)
            .Format("{0:C2}")
            .EditorTemplateName("ComboBoxEditor")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            })
            .HtmlAttributes(new { data_br = "MustBeNumeric,NoSpecialCharacters,MustBePositive" });

        columns.Bound(c => c.CoreCost)
            .Title("Core Cost")
            .Width(90)
            .Format("{0:C2}")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:notNew" }
            })
            .HtmlAttributes(new { data_br = "MustBeNumeric,NoSpecialCharacters,MustBePositive" });

        columns.Bound(c => c.CC)
            .Title("Cost Centre")
            .Filterable(ftb => ftb.Cell(cell => cell.Operator("contains").SuggestionOperator(FilterType.Contains)))
            .EditorTemplateName("ComboBoxEditor")
            .HeaderHtmlAttributes(new { @class = "required-header" })
            .HtmlAttributes(new { @class = "required-cell", required = "required" })
            .Width(120);

        columns.Bound(c => c.TotalCost)
            .Title("Total Cost")
            .Width(90)
            .Format("{0:C2}")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Bound(c => c.LinkCode).Hidden(true);

        columns.Bound(c => c.LastModifiedBy)
            .Title("Modified By")
            .ClientTemplate("#= LastModifiedBy && LastModifiedBy !== 0 ? LastModifiedBy : '(System Generated)' #")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            })
            .Width(160);

        columns.Bound(c => c.LastModifiedDate)
            .Title("Modified Date")
            .Width(160)
            .ClientTemplate("#=  LastModifiedDate !== 0 ? formatToEST(LastModifiedDate) : '(System Generated)' #")
            .EditorViewData(new Dictionary<string, object> {
                { "LockMap", "RbGrid:always;MakevsBuy:notNew;VehicleGrid:always" }
            });

        columns.Command(command =>
        {
            if (!isArchived && isAdmin)
            {
                command.Edit()
                    .Text(" ")
                    .UpdateText("Save")
                    .CancelText(" ")
                    .IconClass("k-icon k-i-edit")
                    .HtmlAttributes(new { title = "Edit", @class = "k-grid-edit" });

                command.Custom("SaveChanges")
                    .Text(" ")
                    .IconClass("k-icon k-i-save")
                    .Click("saveCurrentRow")
                    .HtmlAttributes(new
                    {
                        title = "Save Changes",
                        @class = "k-grid-save-changes",
                        style = "display:none;"
                    });

                command.Custom("Delete")
                    .Click("showDeleteConfirmation")
                    .Text(" ")
                    .IconClass("k-icon k-i-delete")
                    .HtmlAttributes(new
                    {
                        @class = "text-danger",
                        title = "Delete",
                        data_grid = $"ScPartsMaterialDetailsRebuiltPartsGrid",
                        data_url = Url.Action("DeleteScPartsUsedInEstimates", "ScPartsUsedInEstimates"),
                        data_id_field = "id",
                        data_grid_type = "SCPartGrid"
                    });
            }
        }).Width(150);
    })
    .ToolBar(toolbar =>
    {
        if (!isArchived && isAdmin)
        {
            toolbar.Create();
            toolbar.Save();
        }
    })
    .Editable(editable => editable.Mode(GridEditMode.PopUp))
    .Pageable(p => p
        .PageSizes(new int[] { 1, 10, 20, 50 })
        .Position(GridPagerPosition.Bottom)
    )
    .Events(e => e.Edit("onScPartsEdit"))
    .Sortable()
    .Resizable(r => r.Columns(true))
    .DataSource(dataSource => dataSource
        .Ajax()
        .Batch(false)
        .ServerOperation(false)
        .Model(model =>
        {
            model.Id(c => c.MMSStockCode);
            model.Field(c => c.MMSStockCode);
            model.Field(c => c.UnitCost);
            model.Field(c => c.LastModifiedBy).Editable(false);
            model.Field(c => c.LastModifiedDate).Editable(false);
        })
        .Events(events =>
        {
            events.RequestEnd("onScRequestEnd");
            events.Error("onDataSourceError");
        })
        .Read(read => read.Url(Url.Action("GetScPartsUsedInEstimates", "ScPartsUsedInEstimates") + "?id=" + ViewBag.PartNum + "&gridType=" + ViewBag.GridType).Type(HttpVerbs.Get).Data("getVehicleId"))
        .Create(create => create.Url(Url.Action("CreateScPartsUsedInEstimates", "ScPartsUsedInEstimates") + "?id=" + ViewBag.PartNum + "&gridType=" + ViewBag.GridType).Type(HttpVerbs.Post))
        .Update(update => update.Url(Url.Action("UpdateScPartsUsedInEstimates", "ScPartsUsedInEstimates") + "?id=" + ViewBag.PartNum + "&gridType=" + ViewBag.GridType).Type(HttpVerbs.Post))
        .Destroy(destroy => destroy.Url(Url.Action("DeleteScPartsUsedInEstimates", "ScPartsUsedInEstimates") + "?id=" + ViewBag.PartNum + "&gridType=" + ViewBag.GridType).Type(HttpVerbs.Post))
        .Data(partsList) // <-- Bind safe list here
    )
)

@(Html.Kendo().Dialog()
    .Name("partDetailsDialog")
    .Title("Part Details")
    .Width(400)
    .Modal(true)
    .Visible(false)
    .Actions(actions =>
    {
        actions.Add().Text("Close").Primary(true);
    })
)

<div id="notification"></div>

<script>
    function saveCurrentRow(e) {
        e.preventDefault();
        var grid = $("#@gridName").data("kendoGrid");
        var row = $(e.target).closest("tr");
        grid.saveRow(row);
    }

    function onGridDataBound(e) {
        var grid = e.sender;
        grid.tbody.find("tr").each(function () {
            var row = $(this);
            var isInEditMode = row.hasClass("k-grid-edit-row");
            var editButton = row.find(".k-grid-edit");
            var saveButton = row.find(".k-grid-save-changes");

            if (isInEditMode) {
                editButton.hide();
                saveButton.show();
            } else {
                editButton.show();
                saveButton.hide();
            }
        });
    }

    function onGridCellSave(e) {
        setTimeout(function () {
            var grid = $("#@gridName").data("kendoGrid");
            var row = e.container.closest("tr");
            grid.cancelRow(row);
        }, 100);
    }

    function onScRequestEnd(e) {
        if (e.type === "update") {
            var grid = $("#@gridName").data("kendoGrid");
            grid.dataSource.read();
        }
    }

    function onGridCellClose(e) {
        // Placeholder for your existing logic
    }

    function showDeleteConfirmation(e) {
        // Placeholder for your existing delete logic
    }

    function formatToEST(date) {
        // Placeholder for your existing date formatting logic
    }

    function getVehicleId() {
        return { vehicleId: $("#VehicleId").val() };
    }
</script>
