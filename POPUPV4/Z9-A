@{
    ViewData["Title"] = "Total Cost Summary";
    string gridName = $"LabourDetailsGrid_{ViewBag.PartNum}";
}

<script>
    var totalCostGridName = '@gridName';
</script>

<h6>Total Cost Summary</h6>

<div id="totalCostSummaryContainer" class="total-cost-container">
    <!-- Loading indicator -->
    <div id="loadingIndicator" style="text-align: center; padding: 20px;">
        <span class="k-icon k-i-loading" style="font-size: 64px;"></span>
        <p>Loading cost data...</p>
    </div>

    <!-- Material Costs Section -->
    <div class="section-title" style="display: none;">Material Costs</div>
    <div class="form-row" style="display: none;">
        <div class="form-group">
            <label class="form-label">Materials Cost (Without Tax)</label>
            <input id="materialCostWithoutTax" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Tax</label>
            <input id="materialTax" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Material Cost (With Tax)</label>
            <input id="materialCostWithTax" class="read-only" readonly />
        </div>
    </div>

    <!-- Labour Costs Section -->
    <div class="section-title" style="display: none;">Labour Costs</div>
    <div class="form-row" style="display: none;">
        <div class="form-group">
            <label class="form-label">Fringe</label>
            <input id="labourFringe" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Blended Fringe & Benefit Percent</label>
            <input id="blendedFringePercent" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Blended Fringe & Benefit Cost</label>
            <input id="blendedFringeCost" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Overhead</label>
            <input id="labourOverhead" class="read-only" readonly />
        </div>
    </div>
    
    <!-- Blank row -->
    <div class="form-row" style="display: none;">
        <div class="form-group" style="height: 28px;"></div>
    </div>
    
    <!-- Material and Labour Totals Section -->
    <div class="section-title" style="display: none;">Totals (Material and Labour)</div>
    <div class="form-row" style="display: none;">
        <div class="form-group">
            <label class="form-label">Total Material Cost (With Tax)</label>
            <input id="totalMaterialCost" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Total Labour Costs</label>
            <input id="totalLabourCost" class="read-only" readonly />
        </div>
    </div>

    <!-- Overall Totals Section -->
    <div class="section-title" style="display: none;">Total Costs</div>
    <div class="form-row" style="display: none;">
        <div class="form-group">
            <label class="form-label">Total Without Tax</label>
            <input id="totalWithoutTax" class="read-only" readonly />
        </div>
        <div class="form-group">
            <label class="form-label">Total With Tax</label>
            <input id="totalWithTax" class="read-only" readonly />
        </div>
    </div>
</div>

<style>
    /* Match _ScPartsUsed.cshtml styles exactly */
    .total-cost-container { 
        background: white; 
        padding: 12px; 
        border-radius: 4px; 
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    
    .section-title { 
        font-size: 12px; 
        color: #2c3e50; 
        margin-bottom: 6px; 
        padding-bottom: 4px; 
        border-bottom: 1px solid #3498db; 
        display: flex; 
        align-items: center; 
        gap: 5px;
        font-weight: bold;
    }
    
    .form-row { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 6px; 
        align-items: flex-start;
    }
    
    .form-group { 
        display: flex; 
        flex-direction: column; 
        flex: 1;
    }
    
    .form-label { 
        font-size: 11px; 
        color: #2c3e50; 
        font-weight: 600; 
        margin-bottom: 3px;
    }
    
    .read-only { 
        border: 1px solid #d1d5db; 
        border-radius: 3px; 
        padding: 4px 8px; 
        height: 28px; 
        font-size: 12px; 
        background: #f8fafc !important; 
        color: #4b5563 !important; 
        cursor: not-allowed !important;
        width: 100%;
        box-sizing: border-box;
    }
    
    h6 { 
        font-size: 13px; 
        color: #2c3e50; 
        margin-bottom: 8px; 
        border-bottom: 1px solid #3498db; 
        padding-bottom: 4px;
        font-weight: bold;
    }
    
    .k-icon.k-i-loading {
        animation: spin 1s infinite linear;
        color: #3f51b5;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    #loadingIndicator p {
        margin-top: 10px;
        color: #3f51b5;
    }
</style>

<script>
    $(document).ready(function() {
        // Fetch data using the original endpoint
        fetchTotalCostData();
    });

    function fetchTotalCostData() {
        $.ajax({
            url: '@Url.Action("GetTotalCostInEstimates", "TotalCost")',
            type: 'GET',
            data: {
                id: '@ViewBag.PartNum',
                gridType: '@ViewBag.GridType'
            },
            dataType: 'json',
            success: function(data) {
                if (data && data.length > 0) {
                    var costData = data[0]; // Get first item
                    populateCostSummary(costData);
                    $("#loadingIndicator").hide();
                    $(".section-title, .form-row").show();
                } else {
                    showNoDataMessage();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error fetching cost data:", error);
                showNoDataMessage();
            }
        });
    }

    function populateCostSummary(costData) {
        // Material Costs
        setCurrencyValue("#materialCostWithoutTax", costData.MaterialTotalCostNoTax);
        setCurrencyValue("#materialTax", costData.MaterialTotalTaxAmount);
        setCurrencyValue("#materialCostWithTax", costData.MaterialTotalWithTax);
        
        // Labour Costs
        setCurrencyValue("#labourFringe", costData.LabourFringe);
        setPercentValue("#blendedFringePercent", costData.BlendedFringeBenefitPercent);
        setCurrencyValue("#blendedFringeCost", costData.BlendedFringeBenefitCost);
        setCurrencyValue("#labourOverhead", costData.LabourOverhead);
        
        // Totals
        setCurrencyValue("#totalMaterialCost", costData.MaterialTotalWithTax);
        setCurrencyValue("#totalLabourCost", costData.FinalLabourCost);
        setCurrencyValue("#totalWithoutTax", costData.TotalWithoutTax);
        setCurrencyValue("#totalWithTax", costData.TotalWithTax);
    }

    function setCurrencyValue(selector, value) {
        var formatted = value !== null && value !== undefined ? 
            '$' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') : 
            '$0.00';
        $(selector).val(formatted);
    }

    function setPercentValue(selector, value) {
        var formatted = value !== null && value !== undefined ? 
            parseFloat(value).toFixed(2) + '%' : 
            '0.00%';
        $(selector).val(formatted);
    }

    function showNoDataMessage() {
        $("#loadingIndicator").html('<div style="color: #e74c3c; padding: 20px; text-align: center;">No cost data available</div>');
    }
</script>
